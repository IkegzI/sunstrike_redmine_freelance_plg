<% SsrFreelancePayHelper.check_field_on_pay %>
<% if Setting.plugin_sunstrike_redmine_freelance_plg['sunstrike_freelance_auto_select'] == '0' and (request.url.split("/")[-2] == 'issues' or (request.url.split("/").last == 'issues' and request.url.split("/")[-3] == 'projects')) %>
  <script type="text/javascript">
      setInterval(set_attr_assigned_to, 1000);

      $(document).ready(function () {
              document.getElementById('issue_assigned_to_id').setAttribute('onchange', 'check_db_user()');
              check_db_user();
          }
      );

      function set_attr_assigned_to() {

          if (document.getElementById('issue_assigned_to_id') != null) {
              <% if (request.url.split("/").last != 'issues') %>
              if (document.getElementById('update') != null) {
                  if (document.getElementById('update').getAttribute('style') == '') {
                      <% end %>
                      if (document.getElementById('issue_assigned_to_id').getAttribute('onchange') == null) {

                          document.getElementById('issue_assigned_to_id').setAttribute('onchange', 'check_db_user()');
                          check_db_user();
                      }
                  }
              }
              <% if (request.url.split("/").last != 'issues') %>
          }
      }

      <% end %>

      function check_db_user() {
          var atr = document.getElementById('issue_assigned_to_id').value;
          var number_field = '<%= Setting.plugin_sunstrike_redmine_freelance_plg['sunstrike_freelance_field_id'] %>';
          number_field = 'issue_custom_field_values_' + number_field;
          if (document.getElementById('issue_assigned_to_id').value != '') {
              if (document.getElementById(number_field) != null) {
                  $.ajax({
                          type: 'POST',
                          url: '/ssrfreelance/check_pay',
                          data: {
                              check_user_id: atr,
                              project: '<%= request.path.split('/')[2] %>',
                              project_id: "<%= project.nil? ? '' : project.id %>",
                              project_select: function () {
                                  if (document.getElementById('issue_project_id') != null) {
                                      return document.getElementById('issue_project_id').value
                                  } else {
                                      return ''
                                  }
                              }
                          },
                          cache: false,
                          success: function (data) {
                              var number_field = '<%= Setting.plugin_sunstrike_redmine_freelance_plg['sunstrike_freelance_field_id'] %>';
                              number_field = 'issue_custom_field_values_' + number_field;
                              var bang = "";
                              if (document.getElementById('update') != null) {
                                  bang = document.getElementById('update').getAttribute('style')
                              }
                              if (bang == "") {
                                  if (data == 'true') {
                                      document.getElementById(number_field).value = '1';

                                      document.getElementById(number_field).setAttribute('editing', 'no');
                                      document.getElementById(number_field).setAttribute('onmouseout', 'onmouseout_set("' + number_field + '")');

                                  } else {
                                      document.getElementById(number_field).value = '0';
                                      document.getElementById(number_field).setAttribute('editing', 'yes');
                                      document.getElementById(number_field).removeAttribute('onmouseout');
                                  }
                              }

                          }
                      }
                  );
              }
          }
      }

      function onmouseout_set(number_field) {
          var nf = number_field;
          if (document.getElementById(nf).getAttribute('editing') == 'no'){
          document.getElementById(number_field).value = '1';
      }
          
      }
      
      
  </script>
<% end %>