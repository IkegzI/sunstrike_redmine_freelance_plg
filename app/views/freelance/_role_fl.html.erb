<% SsrFreelancePayHelper.check_field_on_pay %>
<% if Setting.plugin_sunstrike_redmine_freelance_plg['sunstrike_freelance_auto_select'] == '0' and (request.url.split("/")[-2] == 'issues') %>
  <script type="text/javascript">
      $(document).ready(function () {
              document.getElementById('issue_assigned_to_id').setAttribute('onchange', 'role_right()');
              if (document.getElementById('issue_assigned_to_id').value != '') {
                  var atr = document.getElementById('issue_assigned_to_id').value;
                  check_db_user(atr);
              }
          }
      );

      function check_db_user(atr) {
          $.ajax({
                  type: 'POST',
                  url: '/ssrfreelance/check_pay',
                  data: {
                      check_user_id: atr,
                      project: '<%= request.path.split('/')[2] %>',
                      project_id: "<%= project.nil? ? '' : project.id %>",
                      project_select: function () {
                          if (document.getElementById('issue_project_id') != null) {
                              return document.getElementById('issue_project_id').value
                          } else {
                              return ''
                          }
                      }
                  },
                  cache: false,
                  success: function (data) {
                      var number_field = '<%= Setting.plugin_sunstrike_redmine_freelance_plg['sunstrike_freelance_field_id'] %>';
                      number_field = 'issue_custom_field_values_' + number_field;
                      if (data == 'true') {
                          document.getElementById(number_field).value = '1';
                      } else {
                          document.getElementById(number_field).value = '0';
                      }

                  }
              }
          );
          pay_info();
      }


      function role_right() {
          var atr = document.getElementById('issue_assigned_to_id').value;
          check_db_user(atr);
      }

      function pay_info() {
          if (document.getElementById('issue_assigned_to_id').value) {
              $.ajax({
                  type: 'POST',
                  data: {
                      check_user_id: document.getElementById('issue_assigned_to_id').value,
                      project: '<%= request.path.split('/')[2] %>',
                      project_id: "<%= project.nil? ? '' : project.id %>",
                      project_select: function () {
                          if (document.getElementById('issue_project_id') != null) {
                              return document.getElementById('issue_project_id').value
                          } else {
                              return ''
                          }
                      }
                  },
                  url: "/ssrfreelance/check_pay_wallet",
                  cache: false,
                  success: function (data) {
                      var answer = JSON.parse(data);
                      document.getElementById('issue_custom_field_values_' + answer[0]['number']).value = answer[0]['value'];
                      document.getElementById('issue_custom_field_values_' + answer[1]['number']).value = answer[1]['value'];
                  }
              });
          }
      }
  </script>
<% end %>