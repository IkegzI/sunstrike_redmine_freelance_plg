<% SsrFreelancePayHelper.check_field_on_pay %>
<% if Setting.plugin_sunstrike_redmine_freelance_plg['sunstrike_freelance_auto_select'] == '0' and request.url.split("/")[-2] == 'issues' %>
  <script type="text/javascript">
      $(document).ready(function () {
              document.getElementById('issue_assigned_to_id').setAttribute('onchange', 'role_right()');
              if (document.getElementById('issue_assigned_to_id') != '') {
                  pay_info();
              }
              var elem = document.getElementById('issue_custom_field_values_<%= Setting.plugin_sunstrike_redmine_freelance_plg['sunstrike_freelance_field_id'] %>');
              elem.setAttribute('onchange', 'status_edit()');
              if (elem.selectedIndex == 2) {
                  <% SsrFreelanceHelper.mark_custom_field_freelance.each do |item| %>
                  var number_field = 'issue_custom_field_values_<%= item.last%>';
                  document.getElementById(number_field).setAttribute('onclick', 'alert_error_edit()');
                  document.getElementById(number_field).setAttribute('onkeypress', 'alert_error_edit()');
                  if (document.getElementById(number_field).tagName != "SELECT") {
                      document.getElementById(number_field).setAttribute('readonly', 'readonly');
                  }
                  if (document.getElementById(number_field).tagName == "SELECT") {
                      document.getElementById(number_field).setAttribute('onchange', 'error_edit_select(' + number_field + ')');
                  }
                  <% end %>
              }
              var atr = document.getElementById('issue_assigned_to_id').value;
              $.ajax({
                  type: 'GET',
                  url: "/ssrfreelance/check/" + atr,
                  cache: false,
                  success: function (data) {
                      var number_field = '<%= Setting.plugin_sunstrike_redmine_freelance_plg['sunstrike_freelance_field_id'] %>';
                      number_field = 'issue_custom_field_values_' + number_field;
                      if (data == 'true') {
                          document.getElementById(number_field).selectedIndex = 1;
                          document.getElementById(number_field).disabled = true;
                          status_edit();
                      } else {
                          document.getElementById(number_field).disabled = false;
                          if (field_check_for_data()) {
                              document.getElementById(number_field).selectedIndex = 2;
                              status_edit();
                          } else {
                              document.getElementById(number_field).selectedIndex = 1;
                          }
                        console.log(data);

                      }
                  }
              });
          }
      );

      function check_db_user(atr) {
          var qr = $.ajax({
              type: 'GET',
              url: "/ssrfreelance/check/" + atr,
              cache: false,
              status: 200,
              success: function (data) {
                  var number_field = '<%= Setting.plugin_sunstrike_redmine_freelance_plg['sunstrike_freelance_field_id'] %>';
                  number_field = 'issue_custom_field_values_' + number_field;
                  if (data == 'true') {
                      document.getElementById(number_field).selectedIndex = 1;
                      document.getElementById(number_field).disabled = true;
                      status_edit();
                  } else {
                      document.getElementById(number_field).disabled = false;
                      if (field_check_for_data()) {
                          document.getElementById(number_field).selectedIndex = 2;
                          status_edit();
                      } else {
                          document.getElementById(number_field).selectedIndex = 1;
                      }
                  }
                  timeout: 4000;
              }
          });
          qr.abort();
          pay_info();

      }


      function role_right() {
          var atr = document.getElementById('issue_assigned_to_id').value;
          check_db_user(atr);
      }

      function status_edit() {

          var number_field = '';
          var key_value = 'issue_custom_field_values_<%= Setting.plugin_sunstrike_redmine_freelance_plg["sunstrike_freelance_field_id"] %>';
          var selected_field = '';

          if (document.getElementById(key_value).selectedIndex == 2) {

              if (field_check_for_data()) {
                  <% SsrFreelanceHelper.mark_custom_field_freelance.each do |item| %>
                  number_field = 'issue_custom_field_values_<%= item.last %>';
                  selected_field = document.getElementById(number_field);
                  if (selected_field.tagName != "SELECT") {
                      selected_field.value = 0;
                      selected_field.setAttribute('readonly', 'readonly');
                  }
                  selected_field.setAttribute('onclick', 'alert_error_edit()');
                  selected_field.setAttribute('onkeypress', 'alert_error_edit()');
                  if (selected_field.tagName == "SELECT") {
                      selected_field.disable = true;
                      selected_field.setAttribute('onchange', 'error_edit_select(' + number_field + ')');
                  }
                  selected_field.options == true;
                  <% end %>
              } else {
                  alert('Задачу больше делает не фрилансер? Чтобы изменить поле “Делает фрилансер” на “Нет” удалите информацию из полей “Фриланс (начислено)”, “Фриланс (выплачено)” и “Фриланс статус');
                  document.getElementById(key_value).selectedIndex = 1;
              }
              pay_info();
          }


          if (document.getElementById('issue_custom_field_values_<%= Setting.plugin_sunstrike_redmine_freelance_plg["sunstrike_freelance_field_id"] %>').selectedIndex == 1) {
              <% SsrFreelanceHelper.mark_custom_field_freelance.each do |item| %>
              number_field = 'issue_custom_field_values_<%= item.last %>';
              selected_field = document.getElementById(number_field);
              selected_field.removeAttribute('onclick');
              selected_field.removeAttribute('onchange');
              selected_field.removeAttribute('onkeypress');
              selected_field.removeAttribute('readonly');
              selected_field.removeAttribute('disabled');
              <% end %>
          }
      }

      function alert_error_edit() {
          alert("Задачу делает фрилансер? Чтобы заполнить данное поле, выставите параметр “Делает фрилансер” на “Да”");
      }

      function error_edit_select(number_field) {
          if (document.getElementById('issue_custom_field_values_<%= Setting.plugin_sunstrike_redmine_freelance_plg["sunstrike_freelance_field_id"] %>').selectedIndex == 1) {
              number_field.selectedIndex = 0;
              alert_error_edit();
          }
      }

      function field_check_for_data() {
          var ans = 0;

          <% SsrFreelanceHelper.mark_custom_field_freelance.each do |item| %>
          number_field = 'issue_custom_field_values_' + <%= item.last %>;
          if (Number.parseInt(document.getElementById(number_field).value) < 1) {
              ans += 1;
          }
          if (document.getElementById(number_field).selectedIndex == 0) {
              ans += 1;
          }
          if (document.getElementById(number_field).tagName != 'SELECT')
          if (document.getElementById(number_field).value == '') {
              ans += 1;
          }
          <% end %>
          if (ans >= <%= SsrFreelanceHelper.mark_custom_field_freelance.size %>) {
              return true;
          } else {
              return false;
          }
      }

      function pay_info() {
          if (document.getElementById('issue_assigned_to_id').value) {
              $.ajax({
                  type: 'GET',
                  url: "/ssrfreelance/check_pay/" + document.getElementById('issue_assigned_to_id').value,
                  cache: false,
                  success: function (data) {
                      var answer = JSON.parse(data);
                      document.getElementById('issue_custom_field_values_' + answer[0]['number']).value = answer[0]['value'];
                      document.getElementById('issue_custom_field_values_' + answer[1]['number']).value = answer[1]['value'];
                  }
              });
          }
      }
  </script>
<% end %>